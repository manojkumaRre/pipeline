{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Template to spin up VM",
  "Parameters": {
    "myKey": {
      "Type": "String"
    },
    "WebServerSecurityGroup": {
      "Type": "String"
    },
    "SubnetID": {
    "Type": "String"
    },
    "InstanceTypeParameter": {
      "Type": "String",
      "Default": "t2.micro",
      "AllowedValues": [
        "t2.micro",
        "t3.small"
      ]
    },
    "ImageId": {
      "Type": "String",
      "Default": "ami-0e01ce4ee18447327"
    }
  },
  "Resources": {
    "JenkinsMaster": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Ref": "ImageId"
        },
        "SubnetId" : {
        "Ref": "SubnetID"
        },
        "InstanceType": {
          "Ref": "InstanceTypeParameter"
        },
        "KeyName": {
          "Ref": "myKey"
        },

         "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "", [
                                "#!/bin/bash -xe\n",   
                                "# Install Jenkins and Java8\n",
                                "sudo yum install wget -y\n",
                                "sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo\n",
                                "sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key\n",
                                "sudo yum install java-1.8.0-openjdk -y\n",
                                "sudo yum update -y\n",
                                "sudo yum install jenkins -y\n",        

                                "sudo service jenkins start\n",
                                "sudo chkconfig jenkins on\n",          

                                "# Wait 30 seconds to allow Jenkins to startup\n",
                                "echo \"Waiting 30 seconds for Jenkins to start.....\"\n",
                                "sleep 30\n",                  

                                "# Restart Jenkins Service\n",
                                "/etc/init.d/jenkins restart\n"
                                
                            ]
                        ]
                    }
                },
        "SecurityGroupIds": [
          {
            "Fn::Join": [
              ",",
              {
                "Ref": "WebServerSecurityGroup"
              }
            ]
          }
        ]
      }
    }

  },
  "Outputs": {
    "PublicIP": {
      "Description": "EC2 public",
      "Value": "EC2Instance1.PublicIp"
    }
  }
}